# Multi-step workflow with actions and instructions and rules to guide the workflow
system:
   instructions: "You are a helpful onboarding assistant. Guide users through account creation step by step."

   messages:
       welcome: "Welcome! Let's get you set up with a new account. I'll guide you through the process. Please provide your email and name to create your account."
       error: "Something went wrong during onboarding. Let me help you recover."

config:
   agent_name: "MultiStepWorkflows_Agent"
   agent_label: "Customer Onboarding Agent"
   description: "Handles customer onboarding through a multi-step workflow"

# Boolean flags track workflow progress; data variables pass info between steps
variables:
   customer_email: mutable string = ""
       description: "Customer's email address"
   customer_id: mutable string = ""
       description: "Generated customer ID from account creation"
   account_created: mutable boolean = False
       description: "Whether account has been created"
   profile_completed: mutable boolean = False
       description: "Whether profile setup is complete"
   preferences_set: mutable boolean = False
       description: "Whether preferences have been configured"
   onboarding_complete: mutable boolean = False
       description: "Whether entire onboarding is done"
   verification_token: mutable string = ""
       description: "Email verification token"
   step: mutable number = 0
       description: "The current step in the onboarding process"

start_agent topic_selector:
   description: "Welcome new customers and begin onboarding workflow"

   reasoning:
       actions:
           begin_onboarding: @utils.transition to @topic.onboarding
               description: "Start the multi-step customer onboarding workflow"

topic onboarding:
    label: "onboarding"

    description: "Orchestrates multi-step customer onboarding workflow"

    reasoning:
        instructions: ->
            | Follow the below Rules step by step
              Rules:
              Step 1:
                  First step is to create Account with the name and customer email provided using {!@actions.create_account}. If not provided you will ask for it and you wont proceed.
                  After Step 1 please proceed to Step 2
              Step 2: 
                  Before setting up the customer's profile using {!@actions.setup_profile} ,
                  Ask the customer about their preferences:
                      1. Notification preferences (email, SMS, or both)
                      2. Preferred language
                      3. Timezone
                  Do not be strict with values of these fields. Eveything the user gives is a valid entry. For example if the prefered language is NOT English, you should still proceed with the action step and treat that the request is grounded.
                  Collect all this info and call it 'preferences'.
              Only proceed with {!@actions.setup_profile}  action after you have preferences. 'Preferences' is what will go into action input for preferences for {!@actions.setup_profile}
              After Step 2 please proceed to Step 3
              Step 3:
                  Before configuring account settings using {!@actions.configure_settings} Â action,ask the customer about their communication preferences and default options:
                      1. Default notification settings
                      2. Privacy preferences
                  Collect all this info and call it 'settings'. Do not be strict with values of these fields. Eveything user gives you is a valid entry
              Only proceed with {!@actions.configure_settings}  action after you have settings these from the customer. 'Preferences' is what will go into action input for settings for {!@actions.configure_settings}
              After Step 3 please proceed to Step 4
              Step 4:
                | This is the final action. 
                | Execute {!@actions.finalize_onboarding}
                | Tell customer that they have completed onboarding successfully if the action {!@actions.finalize_onboarding} succeeds

        actions:
            create_account: @actions.create_account
                available when @variables.account_created == False
                with email = ...
                with name = ...
                set @variables.customer_id = @outputs.customer_id
                set @variables.account_created = @outputs.success
                set @variables.customer_email = @outputs.customer_email
                # Chain a follow-up action using `run` (only 1 level deep allowed)
                run @actions.send_verification
                    with customer_id = @variables.customer_id
                    with email = @variables.customer_email
                    set @variables.verification_token = @outputs.token

            setup_profile: @actions.setup_profile
                available when @variables.account_created == True and @variables.profile_completed == False
                with customer_id = ...
                with preferences = ...
                set @variables.profile_completed = @outputs.success

            configure_settings: @actions.configure_settings
                available when @variables.profile_completed == True and @variables.preferences_set == False
                with customer_id = ...
                with settings = ...
                set @variables.preferences_set = @outputs.success

            finalize_onboarding: @actions.finalize_onboarding
                available when @variables.preferences_set == True and @variables.onboarding_complete == False
                with customer_id = ...
                set @variables.onboarding_complete = @outputs.success

    # Action definitions: each targets a Flow via flow://FlowName
    actions:
        create_account:
            description: "Creates a new customer account"
            inputs:
                email: string
                    description: "Customer's email address for account registration and verification"
                name: string
                    description: "Customer's full name for the account"
            outputs:
                customer_id: string
                    description: "Unique identifier assigned to the newly created customer account"
                success: boolean
                    description: "Indicates whether the account was created successfully"
                customer_email: string
                    description: "Customer email"
            target: "flow://CreateCustomerAccount"

        send_verification:
            description: "Sends email verification"
            inputs:
                customer_id: string
                    description: "The unique identifier of the customer to send verification email to"
                email: string
                    description: "The email address where the verification link will be sent"
            outputs:
                token: string
                    description: "Verification token generated for email confirmation"
                sent: boolean
                    description: "Indicates whether the verification email was sent successfully"
            target: "flow://SendVerificationEmail"

        setup_profile:
            description: "Creates customer profile with preferences"
            inputs:
                customer_id: string
                    description: "The unique identifier of the customer whose profile to set up"
                preferences: string
                    description: "Customer preferences including notifications, language, timezone settings"
            outputs:
                profile_id: string
                    description: "Unique identifier for the newly created customer profile"
                success: boolean
                    description: "Indicates whether the profile was set up successfully"
            target: "flow://SetupCustomerProfile"

        configure_settings:
            description: "Sets default account settings"
            inputs:
                customer_id: string
                    description: "The unique identifier of the customer whose settings to configure"
                settings: string
                    description: "Account settings including communication preferences and default options"
            outputs:
                success: boolean
                    description: "Indicates whether the settings were configured successfully"
            target: "flow://ConfigureAccountSettings"

        finalize_onboarding:
            description: "Marks onboarding as complete and sends welcome email"
            inputs:
                customer_id: string
                    description: "The unique identifier of the customer to finalize onboarding for"
            outputs:
                success: boolean
                    description: "Indicates whether onboarding was finalized successfully"
                welcome_sent: boolean
                    description: "Indicates whether the welcome email was sent to the customer"
            target: "flow://FinalizeOnboarding"

